#!/usr/bin/env python3
"""
æµ‹è¯•è®¢å•è°ƒè¯• - éªŒè¯æŠ¥å…³ç±»å‹é€‰æ‹©é—®é¢˜å·²è§£å†³
"""

from logistics_agent.agent import submit_forecast_order_from_text

def test_order_debug():
    """æµ‹è¯•è®¢å•è°ƒè¯•åŠŸèƒ½"""
    
    print("ğŸ› è®¢å•è°ƒè¯•æµ‹è¯• - éªŒè¯æŠ¥å…³ç±»å‹é€‰æ‹©é—®é¢˜")
    print("="*60)
    
    # æ¨¡æ‹Ÿæˆªå›¾ä¸­çš„åœºæ™¯ï¼šç”¨æˆ·è¾“å…¥äº†æ— æ•ˆçš„æŠ¥å…³ç±»å‹
    print("\nğŸ“ æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥ï¼ˆç±»ä¼¼æˆªå›¾ä¸­çš„åœºæ™¯ï¼‰:")
    print("åˆ›å»ºä¸€ä¸ªä»æ·±åœ³åˆ°æ´›æ‰çŸ¶çš„ç‰©æµè®¢å•ï¼Œä½†æŠ¥å…³ç±»å‹è¾“å…¥é”™è¯¯...")
    
    # è¿™ä¸ªæ–‡æœ¬æ•…æ„åŒ…å«ä¸€ä¸ªæ— æ•ˆçš„æŠ¥å…³ç±»å‹
    text = """ä»æ·±åœ³åˆ°æ´›æ‰çŸ¶ï¼›
customernumber1=T620200611-1001ï¼›
consignee_countrycode=USï¼›
æ”¶ä»¶äºº=John Smithï¼›
æ”¶ä»¶åœ°å€=123 Main Stï¼›
åŸå¸‚=Los Angelesï¼›
é‚®ç¼–=90001ï¼›
çœå·=CAï¼›
æŠ•ä¿=æ˜¯ï¼›
ä¿é¢=100ï¼›
é™©ç§=è´§ç‰©è¿è¾“é™©ï¼›
å¸åˆ«=USDï¼›
ç‰©å“ç±»åˆ«=æ™®è´§ï¼›
æŠ¥å…³ç±»å‹=éœ€è¦æŠ¥å…³"""  # è¿™æ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„ã€æ— æ•ˆçš„è¾“å…¥
    
    print(f"\nè¾“å…¥æ–‡æœ¬åŒ…å«: æŠ¥å…³ç±»å‹=éœ€è¦æŠ¥å…³")
    print("(è¿™æ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„è¾“å…¥ï¼Œç³»ç»Ÿåº”è¯¥æç¤ºå…·ä½“é€‰é¡¹)")
    
    result = submit_forecast_order_from_text(text)
    
    print(f"\nğŸ“Š ç³»ç»Ÿå“åº”:")
    print(f"çŠ¶æ€: {result['status']}")
    
    if result['status'] == 'error':
        error = result.get('error', {})
        error_message = error.get('message', 'N/A')
        print(f"\nâœ… é—®é¢˜å·²è§£å†³ï¼ç³»ç»Ÿç°åœ¨æä¾›äº†å…·ä½“çš„é€‰é¡¹:")
        print(f"é”™è¯¯ä¿¡æ¯: {error_message}")
        
        # æ£€æŸ¥é”™è¯¯ä¿¡æ¯æ˜¯å¦åŒ…å«å…·ä½“çš„é€‰é¡¹
        if "å¿…é¡»ä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©" in error_message:
            print("\nğŸ‰ æˆåŠŸï¼ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿ:")
            print("   1. âœ… è¯†åˆ«æ— æ•ˆçš„æŠ¥å…³ç±»å‹è¾“å…¥")
            print("   2. âœ… æä¾›å…·ä½“çš„å¯é€‰é¡¹ç›®åˆ—è¡¨")
            print("   3. âœ… ç»™å‡ºæ¸…æ™°çš„é”™è¯¯æç¤º")
            print("   4. âœ… å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜")
        else:
            print("\nâŒ é”™è¯¯ä¿¡æ¯æ ¼å¼éœ€è¦è¿›ä¸€æ­¥æ”¹è¿›")
    else:
        print(f"\nâŒ æ„å¤–ç»“æœï¼šè®¢å•ä¸åº”è¯¥åˆ›å»ºæˆåŠŸ")
        print(f"ç»“æœ: {result}")
    
    print("\n" + "="*60)
    
    # ç°åœ¨æµ‹è¯•æ­£ç¡®çš„è¾“å…¥
    print("\nâœ… éªŒè¯ï¼šä½¿ç”¨æ­£ç¡®çš„æŠ¥å…³ç±»å‹")
    
    correct_text = """ä»æ·±åœ³åˆ°æ´›æ‰çŸ¶ï¼›
customernumber1=T620200611-1002ï¼›
consignee_countrycode=USï¼›
æ”¶ä»¶äºº=John Smithï¼›
æ”¶ä»¶åœ°å€=123 Main Stï¼›
åŸå¸‚=Los Angelesï¼›
é‚®ç¼–=90001ï¼›
çœå·=CAï¼›
æŠ•ä¿=æ˜¯ï¼›
ä¿é¢=100ï¼›
é™©ç§=è´§ç‰©è¿è¾“é™©ï¼›
å¸åˆ«=USDï¼›
ç‰©å“ç±»åˆ«=æ™®è´§ï¼›
æŠ¥å…³ç±»å‹=ä¸éœ€æŠ¥å…³"""  # ä½¿ç”¨æ­£ç¡®çš„é€‰é¡¹
    
    print("è¾“å…¥æ–‡æœ¬åŒ…å«: æŠ¥å…³ç±»å‹=ä¸éœ€æŠ¥å…³")
    
    correct_result = submit_forecast_order_from_text(correct_text)
    print(f"\nçŠ¶æ€: {correct_result['status']}")
    
    if correct_result['status'] == 'success':
        print("âœ… ä½¿ç”¨æ­£ç¡®çš„æŠ¥å…³ç±»å‹æ—¶ï¼Œè®¢å•åˆ›å»ºæˆåŠŸï¼")
        data = correct_result.get('data', {})
        result_data = data.get('result', {})
        if isinstance(result_data, dict) and 'data' in result_data:
            api_data = result_data['data']
            if isinstance(api_data, list) and api_data:
                order_info = api_data[0]
                print(f"   è®¢å•å·: {order_info.get('systemnumber', 'N/A')}")
                print(f"   çŠ¶æ€: {order_info.get('msg', 'N/A')}")
    else:
        print("âŒ æ­£ç¡®è¾“å…¥æ—¶è®¢å•åˆ›å»ºå¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥å…¶ä»–é—®é¢˜")
    
    print("\n" + "="*60)
    print("ğŸ¯ æ€»ç»“ï¼šæŠ¥å…³ç±»å‹é€‰æ‹©é—®é¢˜å·²å®Œå…¨è§£å†³ï¼")
    print("   ç°åœ¨ç³»ç»Ÿèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«ç¼ºå¤±æˆ–æ— æ•ˆçš„å­—æ®µï¼Œ")
    print("   å¹¶æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚")

if __name__ == "__main__":
    test_order_debug()